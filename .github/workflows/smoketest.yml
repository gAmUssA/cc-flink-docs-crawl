name: ğŸ§ª Smoketest

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'

jobs:
  smoketest:
    name: ğŸš€ Smoketest
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', '3.11']
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Check code syntax
      run: |
        python -m py_compile crawler.py
        
    - name: ğŸ“ Validate links.txt exists
      run: |
        if [ ! -f "links.txt" ]; then
          echo "âŒ links.txt not found"
          exit 1
        fi
        if [ ! -s "links.txt" ]; then
          echo "âŒ links.txt is empty"
          exit 1
        fi
        echo "âœ… Found $(wc -l < links.txt) URLs in links.txt"
        
    - name: ğŸ§ª Test crawler dry run
      run: |
        # Create a minimal test to verify crawler can start
        python -c "
        import sys
        sys.path.insert(0, '.')
        from crawler import FlinkDocsCrawler
        
        crawler = FlinkDocsCrawler()
        links = crawler.load_links()
        print(f'âœ… Loaded {len(links)} links')
        
        # Test content extraction with a simple example
        content = crawler.extract_content('https://httpbin.org/html')
        print(f'âœ… Content extraction test passed')
        
        print('ğŸ‰ Smoketest completed successfully!')
        "
        
    - name: ğŸ“Š Display environment info
      run: |
        echo "ğŸ Python version: $(python --version)"
        echo "ğŸ“¦ Pip version: $(pip --version)"
        echo "ğŸ”§ Platform: $(uname -a)"
        
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ”’ Install and run safety check
      run: |
        pip install safety
        safety check -r requirements.txt
        
    - name: ğŸ“‹ Check for secrets
      run: |
        # Basic check for common secret patterns
        if grep -r -i "password\|secret\|key\|token" --include="*.py" --include="*.txt" --include="*.md" .; then
          echo "âš ï¸  Potential secrets found - please review"
        else
          echo "âœ… No obvious secrets detected"
        fi